<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>SACRIFICE</title>

  <!-- –ò–∫–æ–Ω–∫–∞: —Ä—ã—Ü–∞—Ä—å + –∫–æ–ª—é—á–∞—è –ø—Ä–æ–≤–æ–ª–æ–∫–∞ (base64) -->
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAHKklEQVR4nO3dW3LbOhJAUbmo+9+yP07VZGxL4oNAo7vXU5nL8bUlNg4aFKlI//379+8/wH/139UDgHEJAHgkAMCTAAAPvvz8/Pl8fv4HgH/07wD4/f39+e//AOBfCAAYJgBgkACAYQIARgkAGOUOAIx6fX39+fkPAP6FAICBAgBGCAAYIQBghACAQQIAxggAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAgFECAMYIABglAGCUAIBRAgBGCQAYIwBglACAUQIARgkAGCUAYJQAg......">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="SACRIFICE">
  <meta name="theme-color" content="#0d0d10">

  <style>
    :root {
      --btn-save: #2e8b57;
      --btn-sold: #b22222;
      --btn-edit: #b8860b;
      --btn-delete: #555;
      --btn-export: #1e90ff;
      --btn-nav: #6a5acd;
      --btn-filter: #d2691e;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }
    body.theme-dark {
      background: #0f0f12;
      color: #e0e0ff;
    }
    body.theme-light {
      background: #ffffff;
      color: #1d1d1f;
    }

    h2 { text-align: center; margin: 16px 0; }

    .btn {
      display: block; width: 100%; padding: 12px;
      margin: 8px 0; border: none; border-radius: 10px;
      color: white; font-size: 16px; font-weight: bold;
      cursor: pointer;
    }
    .btn-save { background: var(--btn-save); }
    .btn-sold { background: var(--btn-sold); }
    .btn-edit { background: var(--btn-edit); }
    .btn-delete { background: var(--btn-delete); }
    .btn-export { background: var(--btn-export); }
    .btn-nav { background: var(--btn-nav); }
    .btn-filter { background: var(--btn-filter); }

    .btn:active {
      opacity: 0.9;
      transform: scale(0.98);
    }

    .backup-buttons, .sale-filter-controls {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .backup-buttons .btn, .sale-filter-controls .btn {
      flex: 1; min-width: 120px;
    }

    input, textarea, select {
      width: 100%; padding: 12px; margin: 8px 0;
      border: 1px solid #444; border-radius: 10px;
      font-size: 16px;
    }
    body.theme-light input,
    body.theme-light textarea,
    body.theme-light select {
      border-color: #ccc;
      background: #f8f9fa;
      color: #1d1d1f;
    }

    #video {
      width: 100%; max-width: 400px; height: auto;
      background: #000; border-radius: 12px;
      display: block; margin: 0 auto;
    }

    .product-card {
      padding: 16px; margin: 12px 0;
      border-radius: 14px;
      position: relative;
    }
    body.theme-dark .product-card { background: #16161e; border: 1px solid #2c2c3a; }
    body.theme-light .product-card { background: #f8f9fa; border: 1px solid #ddd; }

    .category-summary {
      padding: 10px; margin: 8px 0;
      border-radius: 8px;
      font-weight: bold;
    }

    .product-card img {
      max-width: 100%; max-height: 200px;
      border-radius: 10px; margin-top: 10px;
      display: block;
    }

    #form, #sales-screen { display: none; }

    .quantity-controls {
      display: flex; align-items: center; gap: 8px;
      margin: 10px 0;
    }
    .quantity-controls button {
      width: 40px; height: 40px; border-radius: 50%;
      font-size: 18px;
    }
    .quantity-controls span {
      min-width: 40px; text-align: center;
      font-size: 18px; font-weight: bold;
    }

    /* –¶–≤–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –±—ã—Ç–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–∏ */
    .cat-washing { border-left: 4px solid #1e90ff; }          /* –°—Ç–∏—Ä–∞–ª–∫–∏ ‚Äî —Å–∏–Ω–∏–π */
    .cat-fridge { border-left: 4px solid #4682b4; }           /* –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ ‚Äî —Å—Ç–∞–ª—å–Ω–æ–π */
    .cat-stove { border-left: 4px solid #2f2f2f; }            /* –ü–ª–∏—Ç—ã ‚Äî —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π */
    .cat-dishwasher { border-left: 4px solid #5f9ea0; }       /* –ü–æ—Å—É–¥–æ–º–æ–π–∫–∏ ‚Äî –∫–∞–¥–µ—Ç—Å–∫–∏–π */
    .cat-hoodac { border-left: 4px solid #32cd32; }           /* –í—ã—Ç—è–∂–∫–∏ ‚Äî –∑–µ–ª—ë–Ω—ã–π */
    .cat-small { border-left: 4px solid #ff8c00; }            /* –ú–µ–ª–∫–∞—è ‚Äî –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
    .cat-built-in { border-left: 4px solid #8a2be2; }         /* –í—Å—Ç—Ä–æ–π–∫–∞ ‚Äî —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
    .cat-other { border-left: 4px solid #555; }               /* –ü—Ä–æ—á–µ–µ ‚Äî —Å–µ—Ä—ã–π */

    body.theme-dark .summary-washing { background: rgba(30,144,255,0.15); border-left: 3px solid #1e90ff; }
    body.theme-dark .summary-fridge { background: rgba(70,130,180,0.15); border-left: 3px solid #4682b4; }
    body.theme-dark .summary-stove { background: rgba(47,47,47,0.15); border-left: 3px solid #2f2f2f; }
    body.theme-dark .summary-dishwasher { background: rgba(95,158,160,0.15); border-left: 3px solid #5f9ea0; }
    body.theme-dark .summary-hoodac { background: rgba(50,205,50,0.15); border-left: 3px solid #32cd32; }
    body.theme-dark .summary-small { background: rgba(255,140,0,0.15); border-left: 3px solid #ff8c00; }
    body.theme-dark .summary-built-in { background: rgba(138,43,226,0.15); border-left: 3px solid #8a2be2; }
    body.theme-dark .summary-other { background: rgba(85,85,85,0.15); border-left: 3px solid #555; }

    body.theme-light .summary-washing { background: #e6f0ff; border-left: 3px solid #1e90ff; }
    body.theme-light .summary-fridge { background: #eaf5ff; border-left: 3px solid #4682b4; }
    body.theme-light .summary-stove { background: #f0f0f0; border-left: 3px solid #2f2f2f; }
    body.theme-light .summary-dishwasher { background: #eff5f5; border-left: 3px solid #5f9ea0; }
    body.theme-light .summary-hoodac { background: #ebffe6; border-left: 3px solid #32cd32; }
    body.theme-light .summary-small { background: #fff5e6; border-left: 3px solid #ff8c00; }
    body.theme-light .summary-built-in { background: #f0e6ff; border-left: 3px solid #8a2be2; }
    body.theme-light .summary-other { background: #f5f5f5; border-left: 3px solid #555; }
  </style>
</head>
<body class="theme-dark">

<h2>üõ°Ô∏è SACRIFICE</h2>
<video id="video" autoplay playsinline muted></video>
<button id="startScan" class="btn btn-save">üì∏ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>

<div id="form">
  <h3>–¢–æ–≤–∞—Ä: <span id="barcode-display"></span></h3>
  <input type="text" id="brand" placeholder="–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å (Bosch WAT28400 –∏ —Ç.–¥.)">
  <textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" rows="2"></textarea>
  <textarea id="specs" placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–æ–±—ä—ë–º, –∫–ª–∞—Å—Å —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è, —Ü–≤–µ—Ç...)" rows="2"></textarea>
  <select id="category">
    <option value="–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã">–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã</option>
    <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∏ –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫–∏">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∏ –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫–∏</option>
    <option value="–ü–ª–∏—Ç—ã –∏ –≤–∞—Ä–æ—á–Ω—ã–µ –ø–∞–Ω–µ–ª–∏">–ü–ª–∏—Ç—ã –∏ –≤–∞—Ä–æ—á–Ω—ã–µ –ø–∞–Ω–µ–ª–∏</option>
    <option value="–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ –º–∞—à–∏–Ω—ã">–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ –º–∞—à–∏–Ω—ã</option>
    <option value="–í—ã—Ç—è–∂–∫–∏ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã">–í—ã—Ç—è–∂–∫–∏ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã</option>
    <option value="–ú–µ–ª–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞">–ú–µ–ª–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞</option>
    <option value="–í—Å—Ç—Ä–æ–π–∫–∞">–í—Å—Ç—Ä–æ–π–∫–∞</option>
    <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
  </select>
  <input type="number" id="price" step="0.01" placeholder="–¶–µ–Ω–∞, ‚ÇΩ">
  <div class="quantity-controls">
    <button id="decQty" class="btn btn-edit">‚Äì</button>
    <span id="qtyValue">1</span>
    <button id="incQty" class="btn btn-edit">+</button>
  </div>
  <button id="saveProduct" class="btn btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div class="backup-buttons">
  <button id="exportExcelBtn" class="btn btn-export">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
  <button id="exportJsonBtn" class="btn btn-export">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
  <button id="importJsonBtn" class="btn btn-export">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ JSON</button>
</div>
<input type="file" id="importFile" accept=".json" style="display:none;">

<button id="themeToggle" class="btn btn-nav">üåì –¢–µ–º–∞: –¢—ë–º–Ω–∞—è</button>
<input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É –∏–ª–∏ –º–∞—Ä–∫–µ..." style="width:100%; padding:10px; margin:10px 0; border-radius:8px;">

<div id="categorySummary"></div>

<div id="results">
  <h3>–ú–æ–∏ —Ç–æ–≤–∞—Ä—ã</h3>
  <div id="productList"></div>
</div>

<button id="openSalesLog" class="btn btn-nav">üìú –ñ—É—Ä–Ω–∞–ª –ø—Ä–æ–¥–∞–∂</button>

<div id="sales-screen">
  <h2>üìú –ñ—É—Ä–Ω–∞–ª –ø—Ä–æ–¥–∞–∂ ‚Äî SACRIFICE</h2>
  
  <div class="sale-filter-controls">
    <input type="date" id="dateFrom" class="btn-filter-input">
    <input type="date" id="dateTo" class="btn-filter-input">
    <button id="applyDateFilter" class="btn btn-filter">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <select id="saleCategoryFilter" class="btn-nav" style="width:100%; margin:10px 0;">
    <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    <option value="–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã">–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã</option>
    <option value="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∏ –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫–∏">–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏</option>
    <option value="–ü–ª–∏—Ç—ã –∏ –≤–∞—Ä–æ—á–Ω—ã–µ –ø–∞–Ω–µ–ª–∏">–ü–ª–∏—Ç—ã</option>
    <option value="–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ –º–∞—à–∏–Ω—ã">–ü–æ—Å—É–¥–æ–º–æ–π–∫–∏</option>
    <option value="–í—ã—Ç—è–∂–∫–∏ –∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã">–í—ã—Ç—è–∂–∫–∏/–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã</option>
    <option value="–ú–µ–ª–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞">–ú–µ–ª–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞</option>
    <option value="–í—Å—Ç—Ä–æ–π–∫–∞">–í—Å—Ç—Ä–æ–π–∫–∞</option>
    <option value="–ü—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
  </select>

  <button id="exportSalesExcel" class="btn btn-export">üì§ –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥–∞–∂ –≤ Excel</button>
  <button id="backToInventory" class="btn btn-nav">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Ç–æ–≤–∞—Ä–∞–º</button>
  <div id="salesList" style="margin-top:20px;"></div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script type="module">
  import { BrowserMultiFormatReader } from 'https://unpkg.com/@zxing/library@0.20.0/umd/index.js';

  const codeReader = new BrowserMultiFormatReader();
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startScan');
  const formDiv = document.getElementById('form');
  const barcodeDisplay = document.getElementById('barcode-display');
  let currentBarcode = '';
  let currentEditingId = null;

  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('app_theme') || 'theme-dark';
    document.body.className = savedTheme;
    document.getElementById('themeToggle').textContent = `üåì –¢–µ–º–∞: ${savedTheme === 'theme-dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è'}`;

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateFrom').value = today;
    document.getElementById('dateTo').value = today;

    displayProducts();
    updateCategorySummary();
  });

  // === –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ===
  startBtn.onclick = async () => {
    try {
      await codeReader.decodeFromVideoDevice(null, video, (result, err) => {
        if (result) {
          currentBarcode = result.getText();
          barcodeDisplay.textContent = currentBarcode;
          formDiv.style.display = 'block';
          codeReader.reset();
          startBtn.textContent = '‚úÖ –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ';
          startBtn.disabled = true;
          currentEditingId = null;
          resetForm();
        }
      });
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Safari –Ω–∞ iPhone.');
    }
  };

  // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–û–ú –í –§–û–†–ú–ï ===
  let tempQuantity = 1;
  document.getElementById('incQty').onclick = () => {
    tempQuantity++;
    document.getElementById('qtyValue').textContent = tempQuantity;
  };
  document.getElementById('decQty').onclick = () => {
    if (tempQuantity > 1) {
      tempQuantity--;
      document.getElementById('qtyValue').textContent = tempQuantity;
    }
  };

  // === –°–û–•–†–ê–ù–ï–ù–ò–ï ===
  document.getElementById('saveProduct').onclick = () => {
    const brand = document.getElementById('brand').value.trim();
    const desc = document.getElementById('desc').value.trim();
    const specs = document.getElementById('specs').value.trim();
    const category = document.getElementById('category').value;
    const priceStr = document.getElementById('price').value.trim();
    const price = priceStr ? parseFloat(priceStr) : null;
    const quantity = tempQuantity;

    if (!brand && !desc) {
      alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –º–∞—Ä–∫—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ');
      return;
    }

    const product = {
      id: currentEditingId || Date.now().toString(),
      barcode: currentBarcode,
      brand,
      desc,
      specs,
      category,
      price,
      quantity,
      createdAt: currentEditingId ? null : Date.now(),
      lastUpdated: Date.now()
    };

    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    if (currentEditingId) {
      const index = products.findIndex(p => p.id === currentEditingId);
      if (index !== -1) products[index] = product;
    } else {
      if (!product.createdAt) product.createdAt = Date.now();
      products.push(product);
    }
    localStorage.setItem('my_products', JSON.stringify(products));

    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
    resetForm();
    hideForm();
    displayProducts();
    updateCategorySummary();
  };

  function resetForm() {
    document.getElementById('brand').value = '';
    document.getElementById('desc').value = '';
    document.getElementById('specs').value = '';
    document.getElementById('category').value = '–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã';
    document.getElementById('price').value = '';
    tempQuantity = 1;
    document.getElementById('qtyValue').textContent = '1';
  }

  function hideForm() {
    formDiv.style.display = 'none';
    startBtn.disabled = false;
    startBtn.textContent = 'üì∏ –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
  }

  // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–û–í ===
  function displayProducts(filter = '') {
    const list = document.getElementById('productList');
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    products.sort((a, b) => b.lastUpdated - a.lastUpdated);
    
    const filtered = filter 
      ? products.filter(p => 
          p.barcode.includes(filter) || 
          (p.brand && p.brand.toLowerCase().includes(filter.toLowerCase()))
        )
      : products;

    list.innerHTML = filtered.map(p => {
      const catClass = getCategoryClass(p.category);
      const priceStr = p.price !== null && p.price !== undefined 
        ? (p.price.toLocaleString('ru-RU') + ' ‚ÇΩ') 
        : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
      
      return `
        <div class="product-card ${catClass}">
          <strong>–®–ö:</strong> ${p.barcode}<br>
          ${p.brand ? `<strong>–ú–∞—Ä–∫–∞:</strong> ${p.brand}<br>` : ''}
          ${p.desc ? `<div>${p.desc}</div>` : ''}
          ${p.specs ? `<div style="color:#aaa;font-size:14px;">${p.specs}</div>` : ''}
          <div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${p.category}</div>
          <div><strong>–¶–µ–Ω–∞:</strong> ${priceStr}</div>
          <div class="quantity-controls" style="justify-content:flex-start; margin:10px 0;">
            <button onclick="changeQuantity('${p.id}', -1)" class="btn btn-edit" style="width:30px;height:30px;font-size:14px;">‚Äì</button>
            <span style="min-width:30px;text-align:center;">${p.quantity}</span>
            <button onclick="changeQuantity('${p.id}', 1)" class="btn btn-edit" style="width:30px;height:30px;font-size:14px;">+</button>
          </div>
          <button onclick="markAsSold('${p.id}')" class="btn btn-sold" style="width:auto;margin:5px 0;">üì¶ –ü—Ä–æ–¥–∞–Ω–æ</button>
          <button onclick="editProduct('${p.id}')" class="btn btn-edit" style="width:auto;margin:5px 0;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="deleteProduct('${p.id}')" class="btn btn-delete" style="width:auto;margin:5px 0;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
    }).join('');
  }

  // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ HTML) ===
  window.changeQuantity = (id, delta) => {
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    const product = products.find(p => p.id === id);
    if (product) {
      product.quantity = Math.max(1, product.quantity + delta);
      product.lastUpdated = Date.now();
      localStorage.setItem('my_products', JSON.stringify(products));
      displayProducts(document.getElementById('searchInput').value);
      updateCategorySummary();
    }
  };

  window.markAsSold = (id) => {
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    const product = products.find(p => p.id === id);
    if (!product) return;

    const currentQty = product.quantity;
    const soldStr = prompt(`–°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø—Ä–æ–¥–∞–Ω–æ?\n–í –Ω–∞–ª–∏—á–∏–∏: ${currentQty}`, '1');
    if (soldStr === null) return;

    const sold = parseInt(soldStr);
    if (isNaN(sold) || sold < 1) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ ‚â• 1');
      return;
    }
    if (sold > currentQty) {
      alert('–ù–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏!');
      return;
    }

    product.quantity = currentQty - sold;
    product.lastUpdated = Date.now();
    localStorage.setItem('my_products', JSON.stringify(products));

    const saleRecord = {
      id: Date.now().toString(),
      barcode: product.barcode,
      brand: product.brand,
      desc: product.desc,
      category: product.category,
      price: product.price,
      quantity: sold,
      total: product.price ? product.price * sold : null,
      timestamp: Date.now()
    };
    const sales = JSON.parse(localStorage.getItem('sales_log') || '[]');
    sales.unshift(saleRecord);
    localStorage.setItem('sales_log', JSON.stringify(sales));

    displayProducts();
    updateCategorySummary();
    alert(`–ü—Ä–æ–¥–∞–Ω–æ ${sold} —à—Ç.`);
  };

  window.editProduct = (id) => {
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    const product = products.find(p => p.id === id);
    if (!product) return;

    currentBarcode = product.barcode;
    barcodeDisplay.textContent = currentBarcode;
    document.getElementById('brand').value = product.brand || '';
    document.getElementById('desc').value = product.desc || '';
    document.getElementById('specs').value = product.specs || '';
    document.getElementById('category').value = product.category;
    document.getElementById('price').value = product.price !== undefined && product.price !== null ? product.price : '';
    tempQuantity = product.quantity;
    document.getElementById('qtyValue').textContent = product.quantity;
    
    currentEditingId = product.id;
    formDiv.style.display = 'block';
    startBtn.disabled = true;
    startBtn.textContent = '‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
  };

  window.deleteProduct = (id) => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    let products = JSON.parse(localStorage.getItem('my_products') || '[]');
    products = products.filter(p => p.id !== id);
    localStorage.setItem('my_products', JSON.stringify(products));
    
    displayProducts();
    updateCategorySummary();
  };

  // === –ü–û–ò–°–ö ===
  document.getElementById('searchInput').addEventListener('input', (e) => {
    displayProducts(e.target.value.trim());
  });

  // === –ö–ê–¢–ï–ì–û–†–ò–ò ===
  function getCategoryClass(category) {
    if (!category) return 'cat-other';
    if (category.includes('–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ')) return 'cat-washing';
    if (category.includes('–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏')) return 'cat-fridge';
    if (category.includes('–ü–ª–∏—Ç—ã') || category.includes('–≤–∞—Ä–æ—á–Ω—ã–µ')) return 'cat-stove';
    if (category.includes('–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ')) return 'cat-dishwasher';
    if (category.includes('–í—ã—Ç—è–∂–∫–∏') || category.includes('–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã')) return 'cat-hoodac';
    if (category.includes('–ú–µ–ª–∫–∞—è')) return 'cat-small';
    if (category === '–í—Å—Ç—Ä–æ–π–∫–∞') return 'cat-built-in';
    return 'cat-other';
  }

  function getCategorySummaryClass(category) {
    if (!category) return 'summary-other';
    if (category.includes('–°—Ç–∏—Ä–∞–ª—å–Ω—ã–µ')) return 'summary-washing';
    if (category.includes('–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏')) return 'summary-fridge';
    if (category.includes('–ü–ª–∏—Ç—ã') || category.includes('–≤–∞—Ä–æ—á–Ω—ã–µ')) return 'summary-stove';
    if (category.includes('–ü–æ—Å—É–¥–æ–º–æ–µ—á–Ω—ã–µ')) return 'summary-dishwasher';
    if (category.includes('–í—ã—Ç—è–∂–∫–∏') || category.includes('–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã')) return 'summary-hoodac';
    if (category.includes('–ú–µ–ª–∫–∞—è')) return 'summary-small';
    if (category === '–í—Å—Ç—Ä–æ–π–∫–∞') return 'summary-built-in';
    return 'summary-other';
  }

  function updateCategorySummary() {
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    const totals = {};
    products.forEach(p => {
      const cat = p.category || '–ü—Ä–æ—á–µ–µ';
      totals[cat] = (totals[cat] || 0) + (p.quantity || 0);
    });

    const summaryDiv = document.getElementById('categorySummary');
    summaryDiv.innerHTML = Object.entries(totals)
      .map(([cat, total]) => 
        `<div class="category-summary ${getCategorySummaryClass(cat)}">
          <strong>${cat}</strong> ‚Äî –≤—Å–µ–≥–æ: <span>${total}</span> –µ–¥.
        </div>`
      ).join('');
  }

  // === –¢–ï–ú–ê ===
  document.getElementById('themeToggle').onclick = () => {
    const isDark = document.body.classList.contains('theme-dark');
    document.body.className = isDark ? 'theme-light' : 'theme-dark';
    localStorage.setItem('app_theme', isDark ? 'theme-light' : 'theme-dark');
    document.getElementById('themeToggle').textContent = 
      `üåì –¢–µ–º–∞: ${isDark ? '–°–≤–µ—Ç–ª–∞—è' : '–¢—ë–º–Ω–∞—è'}`;
  };

  // === –≠–ö–°–ü–û–†–¢ –í EXCEL ===
  document.getElementById('exportExcelBtn').onclick = () => {
    const products = JSON.parse(localStorage.getItem('my_products') || '[]');
    if (products.length === 0) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
      return;
    }

    const data = products.map(p => ({
      '–®—Ç—Ä–∏—Ö–∫–æ–¥': p.barcode,
      '–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å': p.brand || '',
      '–û–ø–∏—Å–∞–Ω–∏–µ': p.desc || '',
      '–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏': p.specs || '',
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': p.category || '',
      '–¶–µ–Ω–∞, ‚ÇΩ': p.price || '',
      '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': p.quantity || 0,
      '–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è': new Date(p.lastUpdated).toLocaleString('ru-RU')
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–¢–æ–≤–∞—Ä—ã");
    XLSX.writeFile(wb, "–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è_SACRIFICE.xlsx");
  };

  document.getElementById('exportSalesExcel').onclick = () => {
    const sales = JSON.parse(localStorage.getItem('sales_log') || '[]');
    if (sales.length === 0) {
      alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö');
      return;
    }

    const data = sales.map(s => ({
      '–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏': new Date(s.timestamp).toLocaleString('ru-RU'),
      '–®—Ç—Ä–∏—Ö–∫–æ–¥': s.barcode,
      '–ú–∞—Ä–∫–∞ / –ú–æ–¥–µ–ª—å': s.brand || '',
      '–û–ø–∏—Å–∞–Ω–∏–µ': s.desc || '',
      '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': s.category || '',
      '–ü—Ä–æ–¥–∞–Ω–æ, —à—Ç.': s.quantity,
      '–¶–µ–Ω–∞, ‚ÇΩ': s.price || '',
      '–°—É–º–º–∞, ‚ÇΩ': s.total || ''
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "–ü—Ä–æ–¥–∞–∂–∏");
    XLSX.writeFile(wb, "–∂—É—Ä–Ω–∞–ª_–ø—Ä–æ–¥–∞–∂_SACRIFICE.xlsx");
  };

  // === –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢ JSON ===
  document.getElementById('exportJsonBtn').onclick = () => {
    const data = {
      products: JSON.parse(localStorage.getItem('my_products') || '[]'),
      sales: JSON.parse(localStorage.getItem('sales_log') || '[]')
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'SACRIFICE_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  document.getElementById('importJsonBtn').onclick = () => {
    document.getElementById('importFile').click();
  };
  document.getElementById('importFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        if (data.products) {
          localStorage.setItem('my_products', JSON.stringify(data.products));
        }
        if (data.sales) {
          localStorage.setItem('sales_log', JSON.stringify(data.sales));
        }
        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        displayProducts();
        updateCategorySummary();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // === –ñ–£–†–ù–ê–õ –ü–†–û–î–ê–ñ ===
  document.getElementById('openSalesLog').onclick = () => {
    document.getElementById('results').style.display = 'none';
    document.getElementById('sales-screen').style.display = 'block';
    displaySales();
  };

  document.getElementById('backToInventory').onclick = () => {
    document.getElementById('sales-screen').style.display = 'none';
    document.getElementById('results').style.display = 'block';
  };

  document.getElementById('applyDateFilter').onclick = () => {
    displaySales();
  };

  function displaySales() {
    const sales = JSON.parse(localStorage.getItem('sales_log') || '[]');
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const categoryFilter = document.getElementById('saleCategoryFilter').value;

    const filtered = sales.filter(s => {
      const saleDate = new Date(s.timestamp);
      const from = dateFrom ? new Date(dateFrom) : null;
      const to = dateTo ? new Date(dateTo) : null;
      
      let inDate = true;
      if (from) inDate = inDate && saleDate >= from.setHours(0,0,0,0);
      if (to) inDate = inDate && saleDate <= to.setHours(23,59,59,999);
      
      let inCategory = true;
      if (categoryFilter !== 'all') {
        inCategory = s.category === categoryFilter;
      }
      
      return inDate && inCategory;
    });

    filtered.sort((a, b) => b.timestamp - a.timestamp);

    const list = document.getElementById('salesList');
    list.innerHTML = filtered.map(s => {
      const priceStr = s.price ? s.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî';
      const totalStr = s.total ? s.total.toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚Äî';
      return `
        <div class="product-card">
          <div><strong>${new Date(s.timestamp).toLocaleString('ru-RU')}</strong></div>
          <div><strong>–®–ö:</strong> ${s.barcode}</div>
          ${s.brand ? `<div><strong>–ú–∞—Ä–∫–∞:</strong> ${s.brand}</div>` : ''}
          ${s.desc ? `<div>${s.desc}</div>` : ''}
          <div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${s.category || '‚Äî'}</div>
          <div>–ü—Ä–æ–¥–∞–Ω–æ: ${s.quantity} —à—Ç. √ó ${priceStr} = <strong>${totalStr}</strong></div>
        </div>
      `;
    }).join('');
  }
</script>

</body>
</html>